# Важно !

Прочтите p.s. в конце README, там пояснение по комиту после срока

# Сервис для работы с ПВЗ

Данный сервис разработан для управления пунктами выдачи заказов (Работа с приемками и продуктами в ПВЗ).

Сервис позволяет:
* Зарегистрировать пользователя в системе. Доступно несколько ролей (модератор, сотрудник)
* Создать ПВЗ с привязкой к городу (доступно модератору). Варианты городов находятся в базе
* Инициировать и завершить приемку товара в указанном ПВЗ (доступно сотруднику)
* Добавлять и удалять товары в рамках приемки указанного ПВЗ (доступно сотруднику). Варианты типов товара находятся в базе
* Получать полную информацию о ПВЗ, включая приемки с продуктами, с возможностью фильтровать по дате приемки (доступно модератору и сотруднику)

## Реализованный функционал / требования

### Основной:
* ✅ Авторизация с dummyLogin
* ✅ Соответствует нефункциональным требованиям (RPS — 1000, SLI времени ответа — 100 мс, SLI успешности ответа — 99.99%). Проверено при нагрузочном тесте k6
* ✅ Код покрыт unit-тестами, а также реализован интеграционный тест
* ✅ Базой данных выбран PostgreSQL
* ✅ Сервис обернут в контейнер с использованием Docker Compose

 ### Дополнительный:
 * ✅ Регистрация и авторизация через register и login
 * ✅ Настроен логер
 * ✅ Добавлен gRPC сервер для получения списка ПВЗ
 * ✅ Добавлен сбор метрик и отправка их через Prometheus
 * ✅ Используется кодогенерация DTO из swagger.yaml для всех поинтов
 * ✅ Добавлены миграции базы данных для упрощения работы
 * ✅ Добавлен Swagger UI для упрощения использования

## Структура проекта

* `api/`: Информация о API
    * `generated/`: Сгенерированный DTO для API
    * `proto_v1/`: protobuf файл для взаимодействия через gRPC и сгенерированный код для сервиса
    * `spec/`: OpenAPI спецификация
    * `swagger/`: Swagger UI для работы из браузера
* `cmd/pvz-service/main.go`: Точка входа в приложение
* `config/`: Файлы конфигурации проекта
* `internal/`: Основная логика приложения
    * `app/`: Запуск серверов приложения
    * `config/`: Загрузка конфигурации из файла или окружения
    * `controller/`: Все для работы серверов приложения (handler, router, middleware)
    * `errors/`: Общие файлы с различными ошибками
    * `logger/`: Логер приложения
    * `metrics/`: Определение и middleware для регистрации метрик Prometheus
    * `models/`: Структуры данных, используемые в приложении (User, PVZ, Reception, Product и т.д.)
    * `repository/`: Репозитории для взаимодействия с хранилищами данных
    * `service/`: Сервисы приложения с основной бизнес-логикой
* `docker-compose.yml`
* `Dockerfile`
* `loadtest.js`: файл нагрузочного тестирования

## Запуск

Для запуска понадобятся **Docker** и **Docker Compose**.

1.  **Склонируйте проект локально:**
    ```
    git clone https://github.com/R0st0k/PVZ_Service.git
    ```
2.  **В корне проекта введите команду:**
    ```
    docker compose up --build
    ```

Сервисы будут доступны по следующим портам:
* **HTTP API:** `http://localhost:8080`
* **Swagger:** `http://localhost:8080/swagger/`
* **gRPC:** `localhost:3000`
* **Prometheus:** `http://localhost:9000/metrics`

## Остановка

Для остановки введите команду:
```
docker compose down
```

Также можно добавить флаг ```-v``` в конце команды для очистки ```docker volume```

## Кодогенерация

Весь необходимый сгенерированный код уже **присутствует** в репозитории (api/generated и api/proto_v1). Если вы хотите проверить процесс генерации вы можете перегенерировать код:

### Для HTTP сервера:

1. Проверьте, что у Вас установлен [oapi-codegen](https://github.com/oapi-codegen/oapi-codegen)
2. В корне проекта используйте команду:
   ```
   go generate ./...
   ```

### Для gRPC сервера:

1. Проверьте, что у Вас установлен [protoc](https://github.com/protocolbuffers/protobuf/releases)
2. В корне проекта используйте команду:
   ```
   protoc --proto_path=api/proto_v1 --go_out=paths=source_relative:./api/proto_v1 --go-grpc_out=paths=source_relative:./api/proto_v1 api/proto_v1/pvz.proto
   ```

## Тестирование

Для запуска тестов в корне проекта введите команду:
```bash
go test ./...
```

## Заметки
Возникшие вопросы и мои решения:
---
### Вопрос
В задании упоминается название одной из роли Client и Employee
### Решение
Выбран Employee с опорой на OpenAPI Spec и бизнес-логики (это сервис для внутренней работы ПВЗ, все пользователи являются его сотрудниками, а не клиентами)

---

### Вопрос
В текстовом задании описывается пагинация запроса информации о всех ПВЗ. Исходя из текста, пагинация рассчитана на уровень ПВЗ, но внутренняя информация в объеме не контролируется. Исходя из бизнес-логики использования web-приложения, на странице логично было бы ограничивать количество отображаемых продуктов, чтобы выводимая таблица не меняла размер от страницы к странице
### Решение
Выбран вариант пагинации на уровне ПВЗ, поскольку текст и OpenAPI Spec демонстрируют направленность на просмотр ПВЗ, а не продуктов

---

### P.S.
В течении дня ПОСЛЕ срока сдачи были добавлены gRPC и Prometheus сервисы. У меня нет цели кого-либо обмануть, просто, к моему сожалению, из-за болезни я не уложился в свои же сроки. Добавлены эти сервисы лишь для демонстрации того, что эта задача не является трудной или проигнорированной. Я абсолютно пойму, если они не будут учтены при оценке выполнения задания. 

Спасибо, что прочитали это!
 
